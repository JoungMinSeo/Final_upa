<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="signMapper">


	<!-- Pagination용 resultMap -->
	<resultMap type="Pagination" id="pg_rm">
		<result property="listCount" column="DOCU_COUNT" />
	</resultMap>

	<!-- 전자 결재 문서 목록 조회용 resultMap -->
	<resultMap type="Document" id="document_rm">
		<id property="documentNo" column="DOCUMENT_NO"/>
		
		<result property="signNo" column="SIGN_NO"/>
		<result property="documentType" column="DOCUMENT_TYPE"/>
		<result property="documentTitle" column="DOCUMENT_TITLE"/>
		<result property="documentStatus" column="DOCUMENT_STATUS"/>
		<result property="signDraftingDt" column="SIGN_DRAFTING_DT"/>
		<result property="signResult" column="SIGN_RESULT"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberNm" column="MEMBER_NM"/>
		<result property="workNo" column="WORK_NO"/>
	</resultMap>	
	
	<!-- 워크스페이스 참가자 목록 조회용 resultMap -->
	<resultMap type="Management" id="workJoin_rm">
		<id property="memberNo" column="MEMBER_NO"/>
		<id property="workNo" column="WORK_NO"/>
		
		<result property="memberRank" column="MEMBER_RANK"/>
	</resultMap>
	
	<resultMap type="ExpenseReport" id="expenseReport_rm">
		<id property="documentNo" column="DOCUMENT_NO"/>
		
		<result property="expenseDept" column="EXPENSE_DEPT"/>
		<result property="expensePurpose" column="EXPENSE_PURPOSE"/>
		<result property="accountPhone" column="ACCOUNT_PHONE"/>
		<result property="accountDt" column="ACCOUNT_DT"/>
		<result property="deliveryStartDt" column="DELIVERY_START_DT"/>
		<result property="deliveryEndDt" column="DELIVERY_END_DT"/>
		<result property="paymentMethod" column="PAYMENT_METHOD"/>
		
		<collection property="pList" column="ITEM_NO" javaType="java.util.ArrayList" ofType="PurchaseList" select="selectPurchaseList" />
	</resultMap>
	
	<resultMap type="Meeting" id="meeting_rm">
		<id property="documentNo" column="DOCUMENT_NO"/>
		
		<result property="meetingDt" column="MEETING_DT"/>
		<result property="meetingDept" column="MEETING_DEPT"/>
		<result property="meetingPurpose" column="MEETING_PURPOSE"/>
		<result property="meetingContent" column="MEETING_CONTENT"/>
		
		<collection property="meetingJoin" column="JOIN_NO" javaType="java.util.ArrayList" ofType="MeetingJoin" select="selectMeetingJoinList"></collection>
	</resultMap>
	
	<resultMap type="PurchaseList" id="purchaseList_rm">
		<id property="itemNo" column="ITEM_NO"/>
		
		<result property="itemNm" column="ITEM_NM"/>
		<result property="itemUnit" column="ITEM_UNIT"/>
		<result property="itemAmount" column="ITEM_AMOUNT"/>
		<result property="unitPrice" column="UNIT_PRICE"/>
		<result property="totalPrice" column="TOTAL_PRICE"/>
		<result property="documentNo" column="DOCUMENT_NO"/>
	</resultMap>
	
	<resultMap type="SignLine" id="signLine_rm">
		<id property="signNo" column="SIGN_NO"/>
		
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="workNo" column="WORK_NO"/>
		<result property="signStatus" column="SIGN_STATUS"/>
		<result property="signComment" column="SIGN_COMMENT"/>
		<result property="signDt" column="SIGN_DT"/>
		<result property="signOrder" column="SIGN_ORDER"/>
	</resultMap>
	
	<resultMap type="Vacation" id="vacation_rm">
		<id property="documentNo" column="DOCUMENT_NO"/>
		
		<result property="vacationType" column="VACATION_TYPE"/>
		<result property="vacationStartDt" column="VACATION_START_DT"/>
		<result property="vacationEndDt" column="VACATION_END_DT"/>
		<result property="vacationReason" column="VACATION_REASON"/>
	</resultMap>

	<resultMap type="Viewer" id="viewer_rm">
		<id property="signNo" column="SIGN_NO"/>
	
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="workNo" column="WORK_NO"/>
	</resultMap>
	
	<resultMap type="MeetingJoin" id="meetingJoin_rm">
		<id property="joinNo" column="JOIN_NO"/>
		
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="workNo" column="WORK_NO"/>
		<result property="documentNo" column="DOCUMENT_NO"/>
	</resultMap>
	
	
	<!-- 작성한 문서 수 조회 -->
	<select id="getMyDocuListCount" parameterType="map" resultMap="pg_rm">
		SELECT COUNT(*) DOCU_COUNT
		FROM DOCUMENT_LIST
		WHERE WORK_NO = #{workNo} 
		AND DOCUMENT_STATUS = 'Y'
		AND MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 작성한 문서 목록 조회 -->
	<select id="selectMyDocumentList" parameterType="map" resultMap="document_rm">
	 	SELECT * FROM DOCUMENT_LIST
	 	WHERE WORK_NO = #{workNo} 
		AND DOCUMENT_STATUS = 'Y'
		AND MEMBER_NO = #{memberNo}
	 	ORDER BY DOCUMENT_NO DESC
	</select>
	
	<!-- 임시보관함 문서 수 조회 -->
	<select id="getMyTempDocuListCount" parameterType="map" resultMap="pg_rm">
		SELECT COUNT(*) DOCU_COUNT
		FROM DOCUMENT_LIST
		WHERE WORK_NO = #{workNo} 
		AND DOCUMENT_STATUS = 'S'
		AND MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 임시보관함 문서 목록 조회 -->
	<select id="selectMyTempDocumentList" parameterType="map" resultMap="document_rm">
	 	SELECT * FROM DOCUMENT_LIST
	 	WHERE WORK_NO = #{workNo} 
		AND DOCUMENT_STATUS = 'S'
		AND MEMBER_NO = #{memberNo}
	 	ORDER BY DOCUMENT_NO DESC
	</select>
	
	<!-- 워크스페이스 참가자 목록 조회 -->
	<select id="selectWorkspaceJoin" parameterType="_int" resultMap="workJoin_rm">
		SELECT * FROM WORKSPACE_JOIN 
		WHERE WORK_NO = #{workNo}
		ORDER BY MEMBER_RANK DESC
	</select>
	
	<!-- 회원 직급 조회 -->
	<select id="selectRank" parameterType="map" resultType="string">
		SELECT MEMBER_RANK FROM WORKSPACE_JOIN
		WHERE WORK_NO = #{workNo} 
		AND MEMBER_NO = #{memberNo}
	</select>

	<!-- 품의서 작성 -->
	<insert id="insertExpenseReport1" parameterType="map" useGeneratedKeys="true">
		<selectKey keyProperty="documentNo" resultType="_int" order="BEFORE">
			SELECT SEQ_DOC_NO.NEXTVAL FROM DUAL
		</selectKey>
		
		INSERT INTO DOCUMENT VALUES
			( #{documentNo}, 0, '1', #{documentTitle}, #{documentEtc}, DEFAULT )
	</insert>
	<insert id="insertExpenseReport2" parameterType="map">
		INSERT INTO SIGN VALUES
			( 0, SYSTIMESTAMP, 'S', #{memberNo}, #{workNo} )
	</insert>
	<insert id="insertExpenseReport3" parameterType="map">
		INSERT INTO EXPENSE_REPORT VALUES
				( #{documentNo}, #{expenseDept}, #{expensePurpose}, #{accountPhone}, #{accountDt}, 
				  #{deliveryStartDt}, #{deliveryEndDt}, #{paymentMethod} )
	</insert>
	
	<!-- 구매 목록 삽입(List) -->
	<insert id="insertPurchaseList" parameterType="list">
		INSERT INTO PURCHASE_LIST
		SELECT SEQ_PL_NO.NEXTVAL, P.* FROM {
			
			<foreach collection="list" item="pl" separator="UNION ALL">
				SELECT #{pl.itemNm} ITEM_NM,
					   #{pl.itemUnit} ITEM_UNIT,
					   #{pl.itemAmount} ITEM_AMOUNT,
					   #{pl.unitPrice} UNIT_PRICE,
					   #{pl.totalPrice} TOTAL_PRICE,
					   #{pl.documentNo} DOCUMENT_NO FROM DUAL
			</foreach>
		) P
	</insert>

</mapper>
